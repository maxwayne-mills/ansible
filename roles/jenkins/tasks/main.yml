---
- name: Install jenkins key
  apt_key:
    url: https://pkg.jenkins-ci.org/debian/jenkins-ci.org.key
    state: present
    validate_certs: no

- name: Install Debian jenkins repository
  apt_repository:
    repo: deb http://pkg.jenkins.io/debian-stable binary/
    state: present

- name: Install package applications default-jre, default-jre-headless, jenkins
  package:
    name: "{{item}}"
  with_items:
    - default-jre
    - default-jre-headless
    - jenkins

- name: Wait for port 8080
  wait_for:
    port: 8080
    delay: 10

- name: Get jenkins default password
  command: cat "{{jenkins_dir}}/secrets/initialAdminPassword"
  register: admin_pass

- name: Generate hashed password
  shell: echo -n 'password{salt}' |sha256sum | tr -d ' ' | tr -d '-'
  register: hashed_password

- name: wait 
  wait_for:
    port: 8080
    delay: 60

- name: construct new jenkins config file step 1
  replace:
    path: "{{jenkins_dir}}/config.xml"
    regexp: '<isSetupComplete>false</isSetupComplete>'
    replace: '<isSetupComplete>true</isSetupComplete>'
    backup: yes

- name: construct new jenkins config file set state to Running
  replace:
    path: "{{jenkins_dir}}/config.xml"
    regexp: '<name>NEW</name>'
    replace: '<name>RUNNING</name>'
    after: '<isSetupComplete>true</isSetupComplete>'
    
#- name: Copy jenkins config in place
#  copy:
#    src: jenkins-config
#    dest: "{{jenkins_dir}}/config.xml"
#    force: yes

- name: Ensure cmills user directory exists
  file:
    path: "{{jenkins_dir}}/users/cmills"
    state: directory
    owner: jenkins
    group: jenkins
    mode: 0755

- name: Copy Cmills user config file in place
  copy:
    src: cmills-config
    dest: "{{jenkins_dir}}/users/cmills/config.xml" 
    owner: jenkins
    group: jenkins
    mode: 0755
  notify: restart jenkins

- name: Show generated hashed_password
  debug:
    msg: "Hashed password is {{hashed_password.stdout_lines}}"


